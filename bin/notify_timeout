#!/bin/sh
# Prints an error message if `timeout` had to kill a process.
# Assumes --preserve-status was not set on timeout.
# Example usage:
# > this_script timeout 60s rest of the command

# run the given command (and store the pid)
$@ &
ppid=$!
wait $ppid
exit=$?

# echo an error message if the exit code looks like one from timeout
# timeout exit status:
#  124 if command times out
#  125 if timeout itself fails
#  126 if command is found but cannot be invoked
#  127 if command cannot be found
#  137 if command is sent the KILL(9) signal (128+9)
#  the exit status of command otherwise
if [ $exit = "124" ]; then
        echo `date --iso-8601=s` "process $ppid was terminated after timeout!" 1>&2
        exit 124
elif [ $exit = "137" ]; then
        echo `date --iso-8601=s` "process $ppid was killed after timeout!" 1>&2
        exit 137
fi
